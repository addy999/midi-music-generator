<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Midi Music Generator</title>
    <script src="https://unpkg.com/@tonejs/midi"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #0f172a;
        color: #f1f5f9;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
      }
      .card {
        background: #1e293b;
        padding: 3rem;
        border-radius: 24px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        width: 800px;
        max-width: 95%;
        text-align: center;
        position: relative;
      }
      h1 {
        margin-top: 0;
        color: #38bdf8;
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
      }

      .input-group {
        margin: 20px 0;
      }

      input[type="text"] {
        width: 100%;
        padding: 16px;
        box-sizing: border-box;
        border-radius: 12px;
        border: 1px solid #475569;
        background: #334155;
        color: white;
        font-size: 18px;
        margin-bottom: 15px;
        transition: all 0.2s;
      }
      input[type="text"]:focus {
        outline: none;
        border-color: #38bdf8;
        box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
      }

      button {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #38bdf8 0%, #3b82f6 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 8px -1px rgba(59, 130, 246, 0.6);
      }
      button:active {
        transform: translateY(0);
      }
      button:disabled {
        background: #475569;
        cursor: not-allowed;
      }

      .secondary-btn {
        background: #475569;
        margin-top: 10px;
      }

      .settings-btn {
        position: absolute;
        top: 24px;
        right: 24px;
        width: auto;
        padding: 8px 16px;
        background: #334155;
        font-size: 0.9em;
        margin-top: 0;
        border-radius: 8px;
        color: #cbd5e1;
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
      }
      .settings-btn:hover {
        background: #475569;
        color: white;
        border-color: #64748b;
      }

      .github-btn {
        position: absolute;
        top: 24px;
        left: 24px;
        width: auto;
        padding: 8px 16px;
        background: #334155;
        font-size: 0.9em;
        margin-top: 0;
        display: flex;
        align-items: center;
        gap: 6px;
        text-decoration: none;
        color: #cbd5e1;
        transition: all 0.2s;
        border-radius: 8px;
        border: 1px solid transparent;
      }
      .github-btn:hover {
        background: #475569;
        color: white;
        border-color: #64748b;
      }
      .github-icon {
        width: 18px;
        height: 18px;
        fill: currentColor;
      }

      /* Settings Modal */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        align-items: center;
        justify-content: center;
      }
      .modal.show {
        display: flex;
      }
      .modal-content {
        background: #1e293b;
        padding: 2rem;
        border-radius: 16px;
        width: 500px;
        max-width: 90%;
        position: relative;
      }
      .modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 24px;
        cursor: pointer;
        color: #94a3b8;
        background: none;
        border: none;
        width: auto;
        padding: 0;
      }
      .modal-close:hover {
        color: #f1f5f9;
      }
      .modal h2 {
        margin-top: 0;
        color: #38bdf8;
      }
      .form-group {
        margin: 15px 0;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #94a3b8;
        font-size: 0.9em;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px;
        box-sizing: border-box;
        border-radius: 8px;
        border: 1px solid #475569;
        background: #334155;
        color: white;
        font-size: 14px;
      }
      .form-group input:focus,
      .form-group select:focus {
        outline: 2px solid #38bdf8;
        border-color: transparent;
      }
      .form-group small {
        display: block;
        margin-top: 5px;
        color: #64748b;
        font-size: 0.8em;
      }
      .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .modal-actions button {
        flex: 1;
      }

      .status {
        margin-top: 15px;
        min-height: 20px;
        font-size: 0.9em;
        color: #94a3b8;
      }
      .controls {
        margin-top: 20px;
        display: none;
      }

      /* Preset Tags */
      .presets {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin-bottom: 15px;
      }
      .preset-tag {
        background: #334155;
        border: 1px solid #475569;
        color: #cbd5e1;
        padding: 8px 16px;
        border-radius: 24px;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.2s;
        user-select: none;
      }
      .preset-tag:hover {
        background: #475569;
        color: #f1f5f9;
        border-color: #38bdf8;
        transform: translateY(-1px);
      }
      .preset-tag.active {
        background: #38bdf8;
        color: #0f172a;
        border-color: #38bdf8;
      }

      /* Options Row */
      .options-row {
        display: flex;
        gap: 20px;
        justify-content: center;
        align-items: center;
        margin: 20px 0;
        flex-wrap: wrap;
        background: #334155;
        padding: 10px;
        border-radius: 12px;
        display: inline-flex;
      }
      .option-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1em;
        color: #e2e8f0;
        cursor: pointer;
      }
      .option-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #38bdf8;
        cursor: pointer;
      }
      .option-item select {
        background: #334155;
        border: 1px solid #475569;
        color: #f1f5f9;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 0.9em;
        cursor: pointer;
      }
      .option-item select:focus {
        outline: 2px solid #38bdf8;
      }

      /* Visualizer */
      .visualizer-container {
        margin-top: 20px;
        display: none;
      }
      #pianoRoll {
        background: #0f172a;
        border-radius: 8px;
        border: 1px solid #475569;
        width: 100%;
      }

      /* Variations */
      .variations-container {
        display: none;
        margin-top: 15px;
      }
      .variation-tabs {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin-bottom: 10px;
      }
      .variation-tab {
        background: #334155;
        border: 1px solid #475569;
        color: #94a3b8;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.85em;
        cursor: pointer;
        transition: all 0.2s;
        width: auto;
      }
      .variation-tab:hover {
        background: #475569;
      }
      .variation-tab.active {
        background: #38bdf8;
        color: #0f172a;
        border-color: #38bdf8;
      }

      .btn-row {
        display: flex;
        gap: 10px;
      }
      .btn-row button {
        flex: 1;
      }

      /* Examples Section */
      .examples-section {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #334155;
      }
      .examples-section h3 {
        color: #94a3b8;
        font-size: 0.9em;
        margin-bottom: 15px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      #examplesContainer {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }
      .example-item {
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 12px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.2s;
        cursor: pointer;
      }
      .example-item:hover {
        border-color: #38bdf8;
        background: #1e293b;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
      .example-play-btn {
        background: #334155;
        border: none;
        color: #f1f5f9;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: background 0.2s;
        flex-shrink: 0;
        padding: 0;
      }
      .example-play-btn:hover {
        background: #475569;
      }
      .example-play-btn.playing {
        background: #38bdf8;
        color: #0f172a;
      }
      .example-info {
        flex: 1;
        text-align: left;
      }
      .example-name {
        color: #f1f5f9;
        font-size: 0.9em;
        font-weight: 500;
        margin-bottom: 4px;
      }
      .example-duration {
        color: #64748b;
        font-size: 0.75em;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Midi Music Generator</h1>
      <p>v2</p>
      <p>Describe music or click a preset to get started</p>
      <a
        href="https://github.com/addy999/midi-music-generator"
        target="_blank"
        rel="noopener noreferrer"
        class="github-btn"
      >
        <svg
          class="github-icon"
          viewBox="0 0 16 16"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"
          />
        </svg>
        GitHub
      </a>
      <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è Settings</button>

      <!-- Preset Categories -->
      <div class="presets" id="presets">
        <span class="preset-tag" data-prompt="jazz improvisation piano"
          >üé∑ Jazz Improv</span
        >
        <span class="preset-tag" data-prompt="classical piano sonata"
          >üéπ Piano Sonata</span
        >
        <span class="preset-tag" data-prompt="rock guitar riff"
          >üé∏ Rock Anthem</span
        >
        <span class="preset-tag" data-prompt="violin concerto melody"
          >üéª Violin Concerto</span
        >
        <span class="preset-tag" data-prompt="sad ballad piano">üò¢ Ballad</span>
        <span class="preset-tag" data-prompt="triumphant march brass"
          >ÔøΩ Triumphant March</span
        >
        <span class="preset-tag" data-prompt="bell chimes melody"
          >ÔøΩ Bell Chimes</span
        >
        <span class="preset-tag" data-prompt="ambient space pad"
          >üåå Ambient Space</span
        >
        <span class="preset-tag" data-prompt="electronic synth wave"
          >ÔøΩ Synth Wave</span
        >
        <span class="preset-tag" data-prompt="drum solo percussion"
          >ü•Å Drum Solo</span
        >
        <span class="preset-tag" data-prompt="folk tune acoustic guitar"
          >üé∂ Folk Tune</span
        >
        <span class="preset-tag" data-prompt="orchestral symphony"
          >üèõÔ∏è Orchestral</span
        >
      </div>

      <div class="input-group">
        <input
          type="text"
          id="prompt"
          placeholder="Describe sound..."
          autocomplete="off"
        />

        <!-- Options Row -->
        <div class="options-row">
          <label class="option-item">
            <input type="checkbox" id="loopMode" />
            üîÅ Loopable
          </label>
          <label class="option-item">
            Variations:
            <select id="variationCount">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3" selected>3</option>
              <option value="5">5</option>
            </select>
          </label>
        </div>

        <button id="genBtn" onclick="generateMidi()">‚ú® Generate Music</button>
        <div
          id="apiKeyWarning"
          class="status"
          style="color: #f59e0b; display: none"
        >
          ‚ö†Ô∏è API key not configured. Click Settings to get started.
        </div>
      </div>

      <div id="status" class="status"></div>

      <!-- Variation Tabs -->
      <div class="variations-container" id="variationsContainer">
        <div class="variation-tabs" id="variationTabs"></div>
      </div>

      <!-- Piano Roll Visualizer -->
      <div class="visualizer-container" id="visualizerContainer">
        <canvas id="pianoRoll" width="700" height="160"></canvas>
      </div>

      <div class="controls" id="controls">
        <div class="btn-row">
          <button
            id="playWavBtn"
            class="secondary-btn"
            onclick="playWav()"
            style="display: none"
          >
            ‚ñ∂ Play WAV
          </button>
          <button class="secondary-btn" onclick="stopWav()">‚èπ Stop</button>
        </div>
        <div class="btn-row">
          <button class="secondary-btn" onclick="downloadMidi()">
            ‚¨á Download MIDI
          </button>
          <button
            id="downloadWavBtn"
            class="secondary-btn"
            onclick="downloadWav()"
            style="display: none"
          >
            ‚¨á Download WAV
          </button>
        </div>
      </div>
      <div id="wavStatus" class="status"></div>
      <audio id="wavAudio" style="display: none"></audio>

      <!-- Examples Section -->
      <div class="examples-section">
        <h3>üéµ Examples</h3>
        <div id="examplesContainer"></div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeSettings()">√ó</button>
        <h2>LLM Configuration</h2>
        <form id="settingsForm" onsubmit="saveSettings(event)">
          <div class="form-group">
            <label for="provider">Provider</label>
            <select id="provider" onchange="updateProviderFields()">
              <option value="gemini">Gemini (Recommended)</option>
              <option value="openai">OpenAI</option>
              <option value="anthropic">Anthropic</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div class="form-group" id="baseUrlGroup" style="display: none">
            <label for="baseUrl">Base URL</label>
            <input
              type="text"
              id="baseUrl"
              placeholder="https://api.example.com/v1"
            />
            <small>Leave empty to use provider default</small>
          </div>
          <div class="form-group">
            <label for="modelName">Model Name</label>
            <input
              type="text"
              id="modelName"
              placeholder="gemini-2.5-pro"
              required
            />
            <!-- <small id="modelHint"
              >For Gemini, use format: gemini/model-name</small
            > -->
          </div>
          <div class="form-group">
            <label for="apiKey">API Key</label>
            <input
              type="password"
              id="apiKey"
              placeholder="Enter your API key"
              required
            />
            <small
              >Your API key is stored locally in your browser and sent directly
              to the provider to process requests. It is never stored or logged
              on our server.</small
            >
          </div>
          <div class="modal-actions">
            <button
              type="button"
              class="secondary-btn"
              onclick="closeSettings()"
            >
              Cancel
            </button>
            <button type="submit">Save Settings</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Settings Management
      const DEFAULT_SETTINGS = {
        provider: "gemini",
        baseUrl: "",
        modelName: "gemini-2.5-pro",
        apiKey: "",
      };

      function loadSettings() {
        const saved = localStorage.getItem("llmSettings");
        return saved ? JSON.parse(saved) : DEFAULT_SETTINGS;
      }

      function saveSettingsToStorage(settings) {
        localStorage.setItem("llmSettings", JSON.stringify(settings));
      }

      function openSettings() {
        const settings = loadSettings();
        document.getElementById("provider").value = settings.provider;
        document.getElementById("baseUrl").value = settings.baseUrl || "";
        document.getElementById("modelName").value = settings.modelName;
        document.getElementById("apiKey").value = settings.apiKey || "";
        updateProviderFields();
        document.getElementById("settingsModal").classList.add("show");
      }

      function closeSettings() {
        document.getElementById("settingsModal").classList.remove("show");
      }

      function updateProviderFields() {
        const provider = document.getElementById("provider").value;
        const baseUrlGroup = document.getElementById("baseUrlGroup");
        const modelInput = document.getElementById("modelName");
        // const modelHint = document.getElementById("modelHint");

        if (provider === "custom") {
          baseUrlGroup.style.display = "block";
          // modelHint.textContent =
          //   "Enter the model name as accepted by your API";
        } else {
          baseUrlGroup.style.display = "none";
          if (provider === "gemini") {
            modelInput.placeholder = "gemini-2.5-pro";
            if (!modelInput.value || modelInput.value.includes("/")) {
              modelInput.value = "gemini-2.5-pro";
            }
          } else if (provider === "openai") {
            modelInput.placeholder = "gpt-4";
            if (modelInput.value && modelInput.value.includes("/")) {
              modelInput.value = "";
            }
          } else if (provider === "anthropic") {
            modelInput.placeholder = "claude-3-5-sonnet-20241022";
            if (modelInput.value && modelInput.value.includes("/")) {
              modelInput.value = "";
            }
          }
        }
      }

      function saveSettings(event) {
        event.preventDefault();
        const settings = {
          provider: document.getElementById("provider").value,
          baseUrl: document.getElementById("baseUrl").value.trim(),
          modelName: document.getElementById("modelName").value.trim(),
          apiKey: document.getElementById("apiKey").value.trim(),
        };

        if (!settings.modelName || !settings.apiKey) {
          alert("Please provide both model name and API key");
          return;
        }

        saveSettingsToStorage(settings);
        closeSettings();

        // Update UI visibility
        const apiKeyWarning = document.getElementById("apiKeyWarning");
        const genBtn = document.getElementById("genBtn");
        apiKeyWarning.style.display = "none";
        genBtn.style.display = "block";

        alert("Settings saved successfully!");
      }

      // Check if settings exist on page load
      window.addEventListener("DOMContentLoaded", () => {
        const settings = loadSettings();
        const apiKeyWarning = document.getElementById("apiKeyWarning");
        const genBtn = document.getElementById("genBtn");

        if (!settings.apiKey) {
          // Show warning instead of alert
          apiKeyWarning.style.display = "block";
          genBtn.style.display = "none";
        } else {
          apiKeyWarning.style.display = "none";
          genBtn.style.display = "block";
        }

        // Load examples
        loadExamples();
      });

      // Examples functionality
      const examples = [
        {
          name: "Folk Tune Acoustic Guitar",
          file: "folk-tune-acoustic-guitar.wav",
        },
        { name: "Piano Sonata", file: "piano-sonata.wav" },
        { name: "Rock Guitar Riff", file: "rocky.wav" },
        { name: "Violin Concerto", file: "violins.wav" },
      ];

      let currentExampleAudio = null;
      let currentExampleBtn = null;

      function loadExamples() {
        const container = document.getElementById("examplesContainer");

        examples.forEach((example) => {
          const item = document.createElement("div");
          item.className = "example-item";

          const playBtn = document.createElement("button");
          playBtn.className = "example-play-btn";
          playBtn.innerHTML = "‚ñ∂";
          playBtn.onclick = () => toggleExamplePlay(example, playBtn);

          const info = document.createElement("div");
          info.className = "example-info";

          const name = document.createElement("div");
          name.className = "example-name";
          name.textContent = example.name;

          const duration = document.createElement("div");
          duration.className = "example-duration";
          duration.textContent = "Loading...";

          info.appendChild(name);
          info.appendChild(duration);

          item.appendChild(playBtn);
          item.appendChild(info);

          container.appendChild(item);

          // Load audio to get duration
          const audio = new Audio(
            `/static/samples/${encodeURIComponent(example.file)}`
          );
          audio.addEventListener("loadedmetadata", () => {
            const mins = Math.floor(audio.duration / 60);
            const secs = Math.floor(audio.duration % 60);
            duration.textContent = `${mins}:${secs
              .toString()
              .padStart(2, "0")}`;
          });
        });
      }

      function toggleExamplePlay(example, btn) {
        // If clicking the same button, toggle play/pause
        if (currentExampleAudio && currentExampleBtn === btn) {
          if (currentExampleAudio.paused) {
            currentExampleAudio.play();
            btn.innerHTML = "‚è∏";
            btn.classList.add("playing");
          } else {
            currentExampleAudio.pause();
            btn.innerHTML = "‚ñ∂";
            btn.classList.remove("playing");
          }
          return;
        }

        // Stop currently playing audio
        if (currentExampleAudio) {
          currentExampleAudio.pause();
          currentExampleAudio.currentTime = 0;
          if (currentExampleBtn) {
            currentExampleBtn.innerHTML = "‚ñ∂";
            currentExampleBtn.classList.remove("playing");
          }
        }

        // Create and play new audio
        currentExampleAudio = new Audio(
          `/static/samples/${encodeURIComponent(example.file)}`
        );
        currentExampleBtn = btn;

        // Enable looping for examples
        currentExampleAudio.loop = true;

        currentExampleAudio.play();
        btn.innerHTML = "‚è∏";
        btn.classList.add("playing");

        // Handle when audio ends (won't happen with loop, but good for fallback)
        currentExampleAudio.onended = () => {
          btn.innerHTML = "‚ñ∂";
          btn.classList.remove("playing");
          currentExampleAudio = null;
          currentExampleBtn = null;
        };

        // Handle errors
        currentExampleAudio.onerror = () => {
          btn.innerHTML = "‚ñ∂";
          btn.classList.remove("playing");
          currentExampleAudio = null;
          currentExampleBtn = null;
          alert("Error loading example audio");
        };
      }

      let variations = []; // Array of {blob, data, wavBlob, wavUrl, audioBuffer} for each variation
      let currentVariationIndex = 0;
      let isPlaying = false;
      let isStopping = false; // Prevent race conditions
      let animationId = null;
      const wavAudio = document.getElementById("wavAudio");
      let audioContext = null;
      let audioSource = null;
      let startTime = 0;
      let startOffset = 0;

      // Get current selected variation
      function getCurrentMidi() {
        return variations[currentVariationIndex] || null;
      }

      // Preset tag click handler
      document.getElementById("presets").addEventListener("click", (e) => {
        if (e.target.classList.contains("preset-tag")) {
          const prompt = e.target.dataset.prompt;
          document.getElementById("prompt").value = prompt;

          // Visual feedback
          document
            .querySelectorAll(".preset-tag")
            .forEach((t) => t.classList.remove("active"));
          e.target.classList.add("active");
        }
      });

      async function generateMidi() {
        const prompt = document.getElementById("prompt").value;
        const btn = document.getElementById("genBtn");
        const status = document.getElementById("status");
        const controls = document.getElementById("controls");
        const variationsContainer = document.getElementById(
          "variationsContainer"
        );
        const visualizerContainer = document.getElementById(
          "visualizerContainer"
        );
        const loopMode = document.getElementById("loopMode").checked;
        const variationCount = parseInt(
          document.getElementById("variationCount").value
        );

        if (!prompt) return;

        btn.disabled = true;
        controls.style.display = "none";
        variationsContainer.style.display = "none";
        visualizerContainer.style.display = "none";
        document.getElementById("playWavBtn").style.display = "none";
        document.getElementById("downloadWavBtn").style.display = "none";
        document.getElementById("wavStatus").innerText = "";

        stopWav(); // Stop any playing audio
        variations = [];
        currentVariationIndex = 0;

        status.innerText = `AI is composing ${variationCount} variation${
          variationCount > 1 ? "s" : ""
        } in parallel...`;

        try {
          // Load LLM settings
          const llmSettings = loadSettings();
          if (!llmSettings.apiKey) {
            status.innerText = "Please configure your API key in settings";
            btn.disabled = false;
            return;
          }

          // Generate all variations in parallel
          const fetchPromises = [];
          for (let i = 0; i < variationCount; i++) {
            const promise = fetch("/generate_midi", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                prompt: prompt,
                loop: loopMode,
                variation_seed: i,
                llm_settings: llmSettings,
              }),
            }).then(async (response) => {
              if (!response.ok) {
                let err = await response.json();
                throw new Error(err.error || "Server error");
              }
              const blob = await response.blob();
              const arrayBuffer = await blob.arrayBuffer();
              const midiData = new Midi(arrayBuffer);
              return { blob, data: midiData, index: i };
            });
            fetchPromises.push(promise);
          }

          // Wait for all to complete
          const results = await Promise.all(fetchPromises);

          // Sort by index to maintain order
          results.sort((a, b) => a.index - b.index);
          variations = results.map((r) => ({
            blob: r.blob,
            data: r.data,
            wavBlob: null,
            wavUrl: null,
          }));

          status.innerText = `Generated ${variationCount} variation${
            variationCount > 1 ? "s" : ""
          }!`;
          controls.style.display = "block";
          visualizerContainer.style.display = "block";

          // Show variation tabs if more than 1
          if (variationCount > 1) {
            variationsContainer.style.display = "block";
            renderVariationTabs();
          }

          // Draw initial visualization
          drawPianoRoll();

          // Now, generate the WAV for the first variation
          generateWav(currentVariationIndex);
        } catch (e) {
          status.innerText = "Error: " + e.message;
          console.error(e);
        } finally {
          btn.disabled = false;
        }
      }

      async function generateWav(index) {
        const variation = variations[index];
        if (!variation || !variation.blob) return;

        const wavStatus = document.getElementById("wavStatus");
        const playWavBtn = document.getElementById("playWavBtn");
        const downloadWavBtn = document.getElementById("downloadWavBtn");

        wavStatus.innerText = `Converting variation #${
          index + 1
        } to high-quality WAV...`;
        playWavBtn.style.display = "none";
        downloadWavBtn.style.display = "none";

        try {
          const formData = new FormData();
          formData.append("midi_file", variation.blob, "music.mid");

          const response = await fetch("/convert_midi_to_wav", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || "Failed to convert to WAV");
          }

          const wavBlob = await response.blob();
          const wavUrl = URL.createObjectURL(wavBlob);

          // Decode audio for gapless looping
          if (!audioContext) {
            audioContext = new (window.AudioContext ||
              window.webkitAudioContext)();
          }
          const arrayBuffer = await wavBlob.arrayBuffer();
          const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

          variations[index].wavBlob = wavBlob;
          variations[index].wavUrl = wavUrl;
          variations[index].audioBuffer = audioBuffer;

          wavStatus.innerText = `Variation #${index + 1} WAV is ready.`;
          playWavBtn.style.display = "inline-block";
          downloadWavBtn.style.display = "inline-block";
        } catch (e) {
          wavStatus.innerText = "Error creating WAV: " + e.message;
          console.error(e);
        }
      }

      function renderVariationTabs() {
        const tabs = document.getElementById("variationTabs");
        tabs.innerHTML = "";

        variations.forEach((_, i) => {
          const tab = document.createElement("span");
          tab.className = `variation-tab ${
            i === currentVariationIndex ? "active" : ""
          }`;
          tab.innerText = `#${i + 1}`;
          tab.onclick = () => selectVariation(i);
          tabs.appendChild(tab);
        });
      }

      function selectVariation(index) {
        if (index === currentVariationIndex) return;

        const wasPlaying = isPlaying || !wavAudio.paused;

        // Stop current playback safely
        stopWav();

        currentVariationIndex = index;
        renderVariationTabs();
        drawPianoRoll();

        const current = getCurrentMidi();
        if (current.wavBlob) {
          document.getElementById("wavStatus").innerText = `Variation #${
            index + 1
          } WAV is ready.`;
          document.getElementById("playWavBtn").style.display = "inline-block";
          document.getElementById("downloadWavBtn").style.display =
            "inline-block";
        } else {
          generateWav(index);
        }

        // Restart playback on new variation
        if (wasPlaying) {
          // Small delay to ensure clean state
          setTimeout(() => playWav(), 50);
        }
      }

      // Piano Roll Visualizer
      function drawPianoRoll(currentTime = -1) {
        const canvas = document.getElementById("pianoRoll");
        const ctx = canvas.getContext("2d");
        const midi = getCurrentMidi();

        if (!midi) return;

        const width = canvas.width;
        const height = canvas.height;

        ctx.fillStyle = "#0f172a";
        ctx.fillRect(0, 0, width, height);

        const allNotes = [];
        midi.data.tracks.forEach((track) => {
          track.notes.forEach((note) => {
            allNotes.push(note);
          });
        });

        if (allNotes.length === 0) return;

        // Find bounds
        const minPitch = Math.min(...allNotes.map((n) => n.midi));
        const maxPitch = Math.max(...allNotes.map((n) => n.midi));
        const maxTime = Math.max(...allNotes.map((n) => n.time + n.duration));

        const pitchRange = Math.max(maxPitch - minPitch + 1, 12);
        const noteHeight = height / pitchRange;
        const timeScale = width / maxTime;

        // Draw grid lines
        ctx.strokeStyle = "#1e293b";
        ctx.lineWidth = 1;
        for (let i = 0; i <= pitchRange; i++) {
          const y = height - i * noteHeight;
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(width, y);
          ctx.stroke();
        }

        // Draw playhead if playing
        if (currentTime >= 0) {
          const x = currentTime * timeScale;
          ctx.strokeStyle = "#ef4444";
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, height);
          ctx.stroke();
        }

        // Draw notes
        allNotes.forEach((note) => {
          const x = note.time * timeScale;
          const w = note.duration * timeScale;
          const y = height - (note.midi - minPitch + 1) * noteHeight;
          const h = noteHeight - 2;

          // Color based on whether note is currently playing
          const isActive =
            currentTime >= 0 &&
            currentTime >= note.time &&
            currentTime < note.time + note.duration;

          if (isActive) {
            ctx.fillStyle = "#f472b6"; // Pink when active
          } else {
            ctx.fillStyle = "#38bdf8"; // Cyan normally
          }

          ctx.beginPath();
          ctx.roundRect(x + 1, y, Math.max(w - 2, 4), h, 3);
          ctx.fill();
        });
      }

      function playWav() {
        const current = getCurrentMidi();
        if (!current || !current.audioBuffer) return;

        stopWav(); // Stop if already playing

        if (!audioContext) {
          audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
        }

        // Check loop mode
        const loopMode = document.getElementById("loopMode").checked;

        // Create a new source node
        audioSource = audioContext.createBufferSource();
        audioSource.buffer = current.audioBuffer;
        audioSource.loop = loopMode;
        audioSource.connect(audioContext.destination);

        // Start playback
        startTime = audioContext.currentTime;
        startOffset = 0;
        audioSource.start(0, startOffset);
        isPlaying = true;

        // Handle when audio ends (for non-looping)
        audioSource.onended = () => {
          if (isPlaying && !loopMode) {
            isPlaying = false;
            drawPianoRoll(-1);
          }
        };

        function animate() {
          if (!isPlaying) {
            drawPianoRoll(-1);
            return;
          }

          // Calculate current time in the audio
          const elapsed = audioContext.currentTime - startTime + startOffset;
          const duration = current.audioBuffer.duration;
          const currentTime = loopMode
            ? elapsed % duration
            : Math.min(elapsed, duration);

          drawPianoRoll(currentTime);
          animationId = requestAnimationFrame(animate);
        }
        animate();
      }

      function stopWav() {
        if (isStopping) return;
        isStopping = true;

        isPlaying = false;

        // Stop Web Audio API source
        if (audioSource) {
          try {
            audioSource.stop();
            audioSource.disconnect();
          } catch (e) {
            // Source may already be stopped
          }
          audioSource = null;
        }

        if (animationId) {
          cancelAnimationFrame(animationId);
          animationId = null;
        }

        drawPianoRoll(-1);
        isStopping = false;
      }

      function downloadMidi() {
        const midi = getCurrentMidi();
        if (!midi) return;

        const url = window.URL.createObjectURL(midi.blob);
        const a = document.createElement("a");
        a.style.display = "none";
        a.href = url;
        const variationSuffix =
          variations.length > 1 ? `_v${currentVariationIndex + 1}` : "";
        a.download = `gemini_music${variationSuffix}.mid`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
      }

      function downloadWav() {
        const current = getCurrentMidi();
        if (!current || !current.wavBlob) return;

        const url = window.URL.createObjectURL(current.wavBlob);
        const a = document.createElement("a");
        a.style.display = "none";
        a.href = url;
        const variationSuffix =
          variations.length > 1 ? `_v${currentVariationIndex + 1}` : "";
        a.download = `gemini_music${variationSuffix}.wav`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
      }

      document.getElementById("prompt").addEventListener("keypress", (e) => {
        if (e.key === "Enter") generateMidi();
      });

      // Clear preset selection when typing
      document.getElementById("prompt").addEventListener("input", () => {
        document
          .querySelectorAll(".preset-tag")
          .forEach((t) => t.classList.remove("active"));
      });
    </script>
  </body>
</html>
